# プロジェクト技術概要レポート

## 1. PJ概要

### 1.1. プロジェクトの目的と解決する課題

本プロジェクト「n8n」は、現代のソフトウェア開発および運用チームが直面する、複雑かつ多岐にわたるツール間の連携と自動化の課題を解決するために設計された、**テクニカルチーム向けのワークフロー自動化プラットフォーム**である。

今日の技術スタックは、SaaS、データベース、API、クラウドサービスなど、無数のコンポーネントから構成されている。これらを手動で連携させるプロセスは、時間がかかり、ヒューマンエラーが発生しやすく、スケーラビリティに欠ける。n8nは、これらの課題に対し、**ローコードの直感性とプロコードの柔軟性を融合**させることで、堅牢かつスケーラブルな自動化ワークフローの構築を可能にする。

主な目的は、開発者、DevOpsエンジニア、ITプロフェッショナルといった技術的なバックグラウンドを持つユーザーが、その専門知識（APIドキュメントの読解、基本的なスクリプティング能力など）を最大限に活用しながら、反復的なタスクを効率的に自動化できる環境を提供することにある。これにより、チームはより創造的で価値の高い業務に集中できるようになる。

### 1.2. ターゲットユーザーとユースケース

n8nのメインターゲットは、APIの仕様を理解し、必要に応じてカスタムロジックを記述できる技術者である。

-   **ソフトウェア開発者**:
    *   **CI/CDプロセスの自動化**: GitHubのWebhookをトリガーに、ビルド、テスト、デプロイメントのパイプラインを自動化し、結果をSlackやDiscordに通知する。
    *   **データ同期**: 本番データベースの変更を検知し、ステージング環境や分析用データウェアハウスにリアルタイムで同期する。
    *   **APIプロトタイピング**: 複数のマイクロサービスAPIを連携させ、新しい機能を迅速にプロトタイピングし、その場で動作を検証する。

-   **DevOps/SREエンジニア**:
    *   **インシデント対応の自動化**: PagerDutyやSentryからのアラートをトリガーに、サーバーのログを収集し、関連情報をJiraのチケットに起票し、担当者をアサインする。
    *   **インフラ管理**: 定期的にクラウドインフラ（AWS, GCP）の状態をAPI経由でチェックし、未使用リソースのクリーンアップや、コストレポートを自動生成する。

-   **IT管理者**:
    *   **ユーザープロビジョニング**: 人事システム（例: BambooHR）への新規従業員登録をトリガーに、Okta、Google Workspace、Microsoft 365などのアカウントを自動的に作成・設定する。
    *   **SaaS管理**: 各SaaSツールのライセンス使用状況を定期的に集計し、コスト最適化のためのレポートを作成する。

### 1.3. 主要な機能と特徴

n8nは、他の自動化ツールとは一線を画す、技術者向けのユニークな特徴を備えている。

-   **コードによる拡張性 (Code When You Need It)**:
    *   GUIによるノーコード開発の生産性と、コードによる無限の表現力を両立。`Function`ノード（JavaScript）や`Code`ノード（Python）を利用すれば、標準ノードではカバーできない複雑なデータ変換やカスタムロジックを自由に実装できる。npmパッケージを追加して、既存のライブラリ資産を活用することも可能。

-   **AIネイティブなプラットフォーム**:
    *   LangChainとのネイティブ統合により、単なるタスク自動化に留まらず、AIエージェントやLLMを活用した高度なワークフローを構築できる。独自データ（PDF, CSVなど）を取り込んでベクトル化し、社内情報に特化したカスタムAIチャットボットを作成するなど、生成AIのパワーを自動化プロセスに組み込むことが可能。

-   **完全なコントロールと所有権**:
    *   **セルフホストオプション**: オープンソース（フェアコードライセンス）であるため、自社のインフラ（オンプレミス、プライベートクラウド）にn8nをデプロイできる。これにより、データのプライバシーとセキュリティを完全にコントロールできる。エアギャップ環境での運用も可能であり、最高レベルのセキュリティ要件にも対応。
    *   **クラウドサービス**: すぐに利用を開始したいユーザー向けに、n8nが管理するクラウド版も提供。インフラのメンテナンスを気にすることなく、自動化の開発に集中できる。

-   **エンタープライズグレードの機能**:
    *   大規模な組織での利用を想定し、SSO（SAML, OIDC）、ロールベースのアクセス制御（RBAC）、監査ログといったエンタープライズ向けのセキュリティ機能を提供。チームや部門ごとの権限管理を細かく設定できる。

-   **活発なコミュニティと豊富なエコシステム**:
    *   400を超える公式・コミュニティ製のインテグレーション（ノード）と、900以上のすぐに使えるワークフローテンプレートが提供されている。これにより、ゼロから開発を始める必要がなく、既存の資産を組み合わせて迅速に自動化を構築できる。

## 2. 技術要素

n8nのアーキテクチャは、TypeScriptを中心としたモダンな技術スタックで構成されており、スケーラビリティと保守性を高いレベルで両立させている。

-   **主要言語 (TypeScript)**:
    *   プロジェクト全体でTypeScriptが採用されている。静的型付けによるコンパイル時のエラー検出は、大規模で複雑なコードベースの品質と信頼性を維持する上で不可欠である。特に、多数の外部APIと連携し、多様なデータ構造を扱うn8nにおいて、型の恩恵は絶大である。`tsconfig.json`では`strict`モードが有効化されており、高いレベルの型安全性が強制されている。

-   **実行環境 (Node.js)**:
    *   サーバーサイドの実行環境としてNode.jsが採用されている。その非同期I/Oモデルは、多数のAPIリクエストを効率的に並行処理する必要があるn8nのワークロードに最適である。また、世界最大のパッケージエコシステム（npm）を活用できる点も大きな利点となっている。

-   **モノレポ管理 (pnpm Workspaces & Turborepo)**:
    *   n8nは、複数の独立したパッケージ（`n8n-core`, `n8n-workflow`, `frontend`など）を単一のリポジトリで管理するモノレポ構成を採用している。
    *   **pnpm Workspaces**: 依存関係の管理ツール。ディスクスペースを効率的に利用しつつ、各パッケージ間の内部依存関係をシンボリックリンクで解決し、スムーズな開発体験を実現する。
    *   **Turborepo**: 高速なビルドシステム。パッケージ間の依存関係を理解し、変更があったパッケージとその影響範囲のみをリビルド（インクリメンタルビルド）することで、開発サイクルを大幅に高速化する。

-   **フロントエンド (Vue.js 3 & Vite)**:
    *   ワークフローエディタをはじめとするUIは、Vue.js 3で構築されている。その宣言的なコンポーネントベースのアーキテクチャと、きめ細かなリアクティビティシステムは、ドラッグ＆ドロップ操作やパラメータの動的変更が頻繁に発生する複雑なUIの構築に適している。
    *   ビルドツールにはViteが採用されており、高速なHMR（ホットモジュールリプレイスメント）による快適な開発体験を提供する。
    *   状態管理には公式ライブラリであるPiniaが、ルーティングにはVue Routerが用いられており、Vue.jsエコシステムのベストプラクティスに沿った設計となっている。

-   **テストフレームワーク**:
    *   **Vitest**: フロントエンドとバックエンドのユニットテストおよびインテグレーションテストに使用される。Viteとの親和性が高く、高速な実行が可能。
    *   **Playwright**: エンドツーエンド（E2E）テストに使用される。実際のブラウザ（Chromium, Firefox, WebKit）を操作し、ユーザーの視点でのアプリケーション全体の動作を保証する。

-   **コンテナ技術 (Docker)**:
    *   本番環境へのデプロイメントだけでなく、開発環境の構築にもDockerが深く活用されている。VS CodeのDev Containers機能を使えば、依存関係や設定がすべてコンテナ内にパッケージ化された、再現性の高い開発環境をワンクリックで立ち上げることが可能。

## 3. 重要なコンポーネント

プロジェクトは`packages`ディレクトリ以下に、責務ごとに明確に分割されたモジュール群で構成されている。このアーキテクチャが、n8nの高い拡張性と保守性を支えている。

-   **`n8n-workflow` (ワークフローの「静的定義」)**:
    *   ワークフローの構造、つまり「設計図」に責任を持つパッケージ。`Workflow`クラスは、ノード、それらを繋ぐ接続、各種設定といった静的な情報をカプセル化する。また、`Expression`クラスを通じて、`={{ $json.id }}`のような動的なパラメータ（式）の解析と評価の仕組みを提供する。このパッケージは、ワークフローが「どのようなものであるか」を定義する。

-   **`n8n-core` (ワークフローの「動的実行」と「コアサービス」)**:
    *   **実行エンジン**: `n8n-workflow`から渡された「設計図」に基づき、実際にワークフローを実行するランタイムエンジン。`WorkflowExecute`クラスがその心臓部であり、開始ノードから順にノードを実行し、データを次のノードへと渡していくライフサイクルを管理する。
    *   **コアサービス**: 資格情報（Credentials）の暗号化・復号化や、実行データの永続化など、アプリケーション全体で利用される基本的なサービスを提供する。このパッケージは、ワークフローを「どのように動かすか」を定義し、その実行に必要な基盤を提供する。

-   **`nodes-base` (拡張性の基盤)**:
    *   400種類を超える外部サービスとの連携を実現する「ノード」の実装が集約されたパッケージ。すべてのノードは`INodeType`という共通のインターフェースを実装しており、`description`プロパティでUI（パラメータ）を、`execute`メソッドで実行ロジックを定義する。この標準化された実装パターンと、認証処理などを抽象化する豊富なヘルパー関数群が、新規ノードの開発を容易にし、n8nのエコシステム拡大を支えている。

-   **`frontend/editor-ui` (ユーザーインターフェース)**:
    *   ユーザーがワークフローを視覚的に構築するためのWebアプリケーション。Vue.js 3をベースに構築されており、`@vue-flow/core`ライブラリを用いてノードベースのキャンバスUIを実現している。
    *   **状態管理**: 状態管理にはPiniaを採用し、`workflowsStore`や`ndvStore`（Node Details View Store）といったストアを通じて、ワークフローの状態やUIの状態を一元管理する。
    *   **バックエンド通信**: バックエンドとは`packages/client/src/`にカプセル化されたREST APIクライアントを通じて通信し、疎結合を保っている。UIコンポーネントから直接APIを呼び出すのではなく、Piniaストアのアクションを介して実行されるのが基本パターンである。

-   **`cli` (エントリーポイント)**:
    *   セルフホスト環境でn8nを起動するためのコマンドラインインターフェース。`n8n start`や`n8n worker`といったコマンドを提供し、Webサーバーやバックグラウンドワーカープロセスの起動を管理する。内部では`@nestjs/core`を利用してサーバーを起動しており、`packages/main/src/main.module.ts`がアプリケーション全体のモジュールを統括する。

## 4. 新参入開発者への注意事項

### 4.1. アーキテクチャの基本理念：関心の分離

n8nのコードベースを理解する上で最も重要な概念は、**「関心の分離」**である。特に、以下のパッケージ間の役割分担を意識することが、コードの読解と改修を容易にする鍵となる。

-   **`n8n-workflow` (静的定義)**: ワークフローの**データ構造**に特化。ノード間の接続関係、パラメータに書かれた式（Expression）の解析など、「ワークフローとは何か」を定義する。
-   **`n8n-core` (動的実行)**: ワークフローの**実行ロジック**に特化。`n8n-workflow`が定義した構造に従って、実際にノードを一つずつ実行し、データを渡していく。「ワークフローをどう動かすか」を定義する。
-   **`frontend/editor-ui` (UI/UX)**: ワークフローの**視覚的表現とユーザー操作**に特化。状態の管理はPiniaストアに集約され、バックエンドとの通信はAPIクライアントにカプセル化されている。

この明確な分離により、例えば式の評価ロジックを変更する際は`n8n-workflow`に集中でき、実行時のエラーハンドリングを改善する際は`n8n-core`に集中できるなど、変更の影響範囲を局所化しやすくなっている。

### 4.2. 環境構築と主要コマンド

-   **環境要件**: `package.json`に記載の`node` (>=22.16) と `pnpm` (>=10.18.3) のバージョンを厳守すること。`corepack enable`の実行が推奨されている。また、`CONTRIBUTING.md`に記載のある、OSごとのビルドツールのインストールを忘れないこと。
-   **依存関係のインストール**: `pnpm install`
-   **開発モードでの起動**: `pnpm dev` (すべてのパッケージを監視・自動リビルド)
-   **テスト実行**: `pnpm test`
-   **フォーマット適用**: `pnpm format`

### 4.3. コーディングスタイルと規約

-   **TypeScriptの厳格性**: `tsconfig.json`で`strict`モードが有効化されている。`any`型の使用は原則として避け、意図が明確な型定義を心がけること。`unknown`型や型ガードを適切に利用することが求められる。
-   **フォーマッタ**: `Biome` (と一部`Prettier`) によるコードフォーマットが強制される。コミット前に`pnpm format`を実行することが推奨される。
-   **コミットメッセージ**: `feat:`, `fix:`, `docs:` のように、変更の種類を接頭辞で示すConventional Commitsの規約に従う。

### 4.4. デバッグのヒント

-   **バックエンド**: VS Codeのデバッガーを利用するのが最も効率的。ルートディレクトリの`.vscode/launch.json`には、n8nのバックエンドプロセスにアタッチするための設定が予め用意されている。ブレークポイントを貼って、変数の内容や処理の流れをステップ実行で確認できる。
-   **フロントエンド**: ブラウザの開発者ツール（特にVue Devtools拡張機能）が必須。コンポーネントの階層、propsや状態（Piniaストア）の内容をリアルタイムで確認できる。
-   **ワークフロー内**: `DebugHelper`ノードは、特定の接続を流れるデータ（JSON）をそのまま表示してくれるため、データ変換の途中経過を確認するのに非常に役立つ。

## 5. 今後の開発計画（提案）

現在のコードベースは非常に高い品質を保っているが、さらなる品質向上と開発者体験の改善のため、以下の計画を提案する。

1.  **静的コード解析の本格導入による信頼性向上**:
    *   **現状**: `biome.jsonc`で`linter`が無効化されており、フォーマッタとしての利用に留まっている。
    *   **提案**: Biomeの`linter`機能を有効化し、推奨ルールセットを適用する。これにより、`no-unused-vars`（未使用変数）や`no-explicit-any`（any型の禁止）といったルールを通じて、潜在的なバグをコーディング段階で自動的に検出し、コードの堅牢性をさらに高める。また、`organizeImports`を有効化し、import文を自動でソート・整理することで、コードの可読性を向上させる。
    *   **効果**: コードレビューの負担を軽減し、より本質的なロジックの議論に集中できるようになる。新参入者も規約を意識せずとも品質の高いコードを記述しやすくなる。

2.  **テストカバレッジの閾値設定による品質の維持**:
    *   **現状**: カバレッジ計測の仕組みは存在するが、CIでカバレッジ率を強制する閾値が設定されていない。
    *   **提案**: `vitest.config.ts`に`coverage.thresholds`を設定する。まずは現状のカバレッジ率（例: 全体で85%）を基準とし、それを下回るプルリクエストをマージできないようにCIで強制する。将来的には、この目標値を段階的に引き上げていく（例: 90%）。
    *   **効果**: テストが不十分なコードがマージされることを防ぎ、リグレッションのリスクを低減する。コードベース全体の品質に対する安心感を醸成し、積極的なリファクタリングを促進する。

3.  **主要コンポーネントのアーキテクチャドキュメント拡充**:
    *   **現状**: 本レポートで作成したドキュメントは存在するが、コードベース内に開発者向けのより詳細なアーキテクチャドキュメントは不足している。
    *   **提案**: `n8n-core`の`WorkflowExecute`クラスや、`frontend/editor-ui`の`NodeView.vue`と関連するPiniaストアなど、特に複雑で重要なモジュールに対して、その設計意図、責務、他モジュールとの連携方法を記述したMarkdownドキュメントを`AGENTS.md`や`README.md`に整備する。
    *   **効果**: 新規参入者がコードの全体像を迅速に把握し、開発に参加するまでのオンボーディング期間を短縮する。

これらの施策は、n8nのコード品質をさらに一段階引き上げ、将来の機能追加や変更に対する俊敏性を確保するために不可欠である。詳細な計画は`documentation/improvement_plan.md`を参照。
