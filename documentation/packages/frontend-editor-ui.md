# パッケージ: `frontend/editor-ui`

## 1. 概要

`frontend/editor-ui`パッケージは、n8nアプリケーションの**フロントエンド**、特にユーザーがワークフローを視覚的に構築するための**ワークフローエディタUI**の責務を担います。Vue.js 3をベースとしたシングルページアプリケーション（SPA）として構築されており、n8nの「顔」となる部分です。

## 2. 主要なコンセプトとアーキテクチャ

このパッケージのアーキテクチャは、モダンなフロントエンド設計のベストプラクティスに沿っています。

-   **コンポーネントベース:** UIは、再利用可能で自己完結したコンポーネントの組み合わせで構築されています。
-   **状態管理の一元化:** アプリケーション全体のグローバルな状態は、状態管理ライブラリ**Pinia**の「ストア」に集約されています。これにより、データの流れが予測可能になり、コンポーネント間の複雑な`props`のバケツリレーを回避しています。
-   **ロジックの再利用:** Vue 3の**Composition API**（`composables`）を積極的に活用し、リアクティブなロジックをコンポーネントから分離・再利用可能にしています。

### 2.1. 中核コンポーネント: `NodeView.vue`

`src/app/views/NodeView.vue`は、ワークフローエディタ画面全体の**司令塔**となるルートコンポーネントです。

-   **責務:**
    -   主要なUIコンポーネント（キャンバス、ノード詳細パネルなど）を統合し、レイアウトを構成します。
    -   各コンポーネントから発行されるイベント（例: 「ノードがクリックされた」）をハンドリングします。
    -   イベントに応じて、`composables`に定義されたビジネスロジックを呼び出します。

### 2.2. 主要UIコンポーネント

-   **`WorkflowCanvas.vue`:** ワークフローのノードと接続を視覚的に表示するキャンバス領域。`@vue-flow/core`ライブラリを基盤としており、ドラッグ＆ドロップや接続作成といったユーザー操作を受け付け、イベントを発行します。
-   **`NodeDetailsView.vue`:** 選択されたノードの詳細なパラメータ（入力フィールド、認証情報選択など）を表示・編集するためのパネルです。
-   **`NodeCreation.vue`:** 新しいノードを検索し、キャンバスに追加するためのパネルです。

### 2.3. 状態管理 (Pinia Stores)

`src/app/stores/`ディレクトリに、機能ごとに分割されたストアが定義されています。

-   **`workflows.store.ts`**: 現在編集中のワークフローの状態（ノード、接続、設定など）を保持する、**最も重要なストア**です。アプリケーションの単一の信頼できる情報源（Single Source of Truth）として機能します。
-   **`ndv.store.ts` (Node Details View Store)**: どのノードが詳細パネルでアクティブになっているか、というUIの状態を管理します。
-   **`ui.store.ts`**: モーダルの表示状態や、ワークフローに未保存の変更があるか (`stateIsDirty`) といった、グローバルなUIの状態を管理します。

### 2.4. ビジネスロジック (Composables)

`src/app/composables/`ディレクトリに、再利用可能なビジネスロジックが集約されています。

-   **`useCanvasOperations.ts`**: ノードの追加・削除、接続の作成、コピー＆ペースト、Undo/Redoなど、キャンバス上で行われる**ほぼ全てのユーザー操作のロジック**をカプセル化しています。このComposable内の関数が、最終的に`workflows.store.ts`などのPiniaストアのアクションを呼び出して状態を変更します。
-   **`useRunWorkflow.ts`**: ワークフローの実行ボタンが押された際のバックエンドへのAPIリクエストなどを担当します。
-   **`useWorkflowSaving.ts`**: ワークフローの保存処理と、未保存の変更がある場合にユーザーに警告するロジックを担当します。

## 3. ディレクトリ構造

`packages/frontend/editor-ui/src/app/`ディレクトリ下の主要な構造は以下の通りです。

```
src/app/
├── views/                  # ページレベルのルートコンポーネント
│   └── NodeView.vue        # ワークフローエディタ画面の司令塔
├── components/             # 再利用可能なUI部品（ボタン、モーダルなど）
├── features/               # より大きな機能単位のコンポーネント群（ワークフローキャンバス、ノード詳細パネルなど）
├── stores/                 # Piniaストア（状態管理）
├── composables/            # 再利用可能なビジネスロジック
├── api/                    # バックエンドとのAPI通信層
└── router.ts               # URLルーティングの定義
```

## 4. データフローの典型例（ノード名変更）

1.  **ユーザー**が`NodeDetailsView`のノード名入力フィールドを編集する。
2.  `NodeDetailsView`が`@input`イベントを発行する。
3.  `NodeView`がイベントを捕捉し、`useCanvasOperations`の`renameNode`関数を呼び出す。
4.  `renameNode`関数が`workflowsStore`の`renameNode`アクションを呼び出す。
5.  `workflowsStore`が状態（`state.nodes`）を更新する。
6.  Piniaのリアクティビティにより、状態の変更が`WorkflowCanvas`と`NodeDetailsView`の両方に伝播し、表示が自動的に更新される。

このように、ユーザー操作を起点として、状態の変更が必ずPiniaストアを経由する**単方向データフロー**が徹底されており、アプリケーションの予測可能性と保守性を高めています。
