# 改善案及び改善開発計画

## 1. はじめに

本ドキュメントは、n8nプロジェクトの持続的な成長と品質向上を目的として、現状のコードベースを多角的に分析し、具体的な改善案とそれを実行するための開発計画を提示するものである。分析は、主に以下の4つの観点から実施した。

- **可読性 (Readability):** 新規参入者がコードの意図を迅速かつ正確に理解できるか。
- **保守性 (Maintainability):** 仕様変更や機能追加、バグ修正が容易かつ安全に行えるか。
- **性能 (Performance):** ワークフロー実行時やUI操作時において、最適なパフォーマンスを発揮できているか。
- **信頼性 (Reliability):** 予期せぬエラーやデータ損失を防ぎ、安定した動作を提供できるか。

## 2. 改善案

### 2.1. 可読性・保守性の向上

#### 2.1.1. フロントエンドの状態管理の複雑性緩和

**現状の課題:**
- `packages/frontend/editor-ui`では、状態管理ライブラリとしてPiniaが採用されているが、一部のコンポーネントでは、コンポーネントローカルな`ref`や`reactive`による状態管理と、グローバルなPiniaストアの状態管理が混在している。
- 特に、ノードのプロパティや接続情報など、複数のコンポーネント間で共有・編集される状態のデータの流れが追いにくくなっている箇所が見受けられる。これにより、状態の不整合や意図しない再レンダリングを引き起こす可能性がある。

**改善提案:**
1.  **状態管理方針の明確化:**
    - グローバル状態（認証情報、ワークフロー全体の設定など）とローカル状態（UIコンポーネント固有の一時的な状態など）の切り分け基準をドキュメント化する。
    - Piniaストアの設計原則（ストアの分割単位、Action/Getterの責務など）を定義し、チーム内で共有する。
2.  **リファクタリング:**
    - 複数のコンポーネントで利用されている`ref`/`reactive`な状態を、適切なPiniaストアに移行する。
    - Vue Devtoolsを活用して状態の流れを可視化し、複雑な依存関係を持つ箇所を特定・単純化する。
    - `props`のバケツリレーが多層にわたる場合は、`provide/inject`やPiniaストアの活用を検討する。

#### 2.1.2. `nodes-base`における共通処理の抽象化と再利用

**現状の課題:**
- `packages/nodes-base`内の各ノード（例: `HttpRequest.node.ts`）には、認証情報の取得、リクエストの送信、エラーハンドリングなど、多くのノードで共通するロジックが個別に実装されている。
- `IExecuteFunctions`が提供するヘルパー関数群は非常に有用だが、さらに上位のビジネスロジックレベルでの共通化の余地がある。例えば、「OAuth2認証を行い、APIにリクエストを投げる」といった一連の処理は、多くのノードで必要とされる。

**改善提案:**
1.  **認証処理の抽象化:**
    - `services/credentials.ts`を拡張し、各種認証方式（OAuth2, APIキーなど）に対応した汎用的な認証ヘルパークラスまたは関数を作成する。
    - ノード側では、具体的な認証フローを意識することなく、`credentials.get('myApi')`のように抽象化されたインターフェースを呼び出すだけで認証情報を取得できるようにする。
2.  **リクエスト処理の共通化:**
    - `HttpRequest.node.ts`で実装されているような汎用的なリクエスト処理（リトライ、タイムアウト、エラーハンドリング）を、独立したユーティリティモジュールとして切り出す。
    - 各ノードはこのユーティリティを利用することで、ボイラープレートコードを削減し、本質的なビジネスロジックの実装に集中できるようにする。

### 2.2. 性能の向上

#### 2.2.1. ワークフロー実行エンジンのパフォーマンス最適化

**現状の課題:**
- `WorkflowExecute.ts`におけるワークフロー実行プロセスは、直列的であり、多数のノードを持つ大規模なワークフローや、長時間実行されるノードが含まれる場合に、全体の実行時間が長くなる可能性がある。
- 特に、ループ処理や分割・集約（Split in Batches / Merge）ノードにおいて、大量のデータを扱う際のメモリ消費量や処理効率に課題が生じる可能性がある。

**改善提案:**
1.  **並列実行の導入:**
    - ワークフローの依存関係グラフを静的に解析し、依存関係のないノードのブランチを特定する。
    - 特定されたブランチを、`worker_threads`や`Promise.all`などを活用して並列実行する。これにより、I/Oバウンドなタスク（APIリクエストなど）が複数ある場合に、全体の実行時間を大幅に短縮できる可能性がある。
2.  **データストリーミングの活用:**
    - 現在、ノード間のデータはJSONオブジェクトの配列としてメモリ上で受け渡しされている。
    - 大量データを扱うノード（例: Read Binary File, HTTP Requestで大きなファイルを取得する場合）のために、Node.jsのStream APIを活用したデータの受け渡しを検討する。これにより、メモリ使用量を大幅に削減し、大規模なデータ処理を安定して行えるようにする。

### 2.3. 信頼性の向上

#### 2.3.1. Jestテストカバレッジの閾値設定とCIでの強制

**現状の課題:**
- `jest.config.js`でカバレッジ計測は有効になっているが、カバレッジが一定の基準を満たしているかを保証するための閾値（`coverageThreshold`）が設定されていない。
- これにより、テストが不十分なコードがマージされてしまうリスクや、リファクタリングによって意図せずテストが削除されるリスクがある。

**改善提案:**
1.  **`coverageThreshold`の設定:**
    - `jest.config.js`に`coverageThreshold`プロパティを追加し、グローバル、またはパッケージごとに閾値を設定する。
    - まずは現状の平均カバレッジを基準値とし、段階的に目標値を引き上げていく（例: `lines: 80%`, `branches: 75%`）。
    - CIプロセスにカバレッジチェックを組み込み、閾値を下回った場合にはビルドが失敗するように設定する。

#### 2.3.2. Biome Linterの有効化による静的解析の強化

**現状の課題:**
- リポジトリルートの`biome.jsonc`で`linter`が無効化されており、TypeScriptの型チェックだけでは検出できない潜在的なバグやコードスタイルの一貫性の欠如を見逃す可能性がある。

**改善提案:**
1.  **Linterの有効化:**
    - `biome.jsonc`で`"linter": { "enabled": true }`を設定する。
2.  **推奨ルールの適用:**
    - `"recommended": true`を有効にし、Biomeが推奨するベストプラクティスをプロジェクト全体に適用する。
    - `organizeImports`も有効化し、import文の自動ソートを行うことで、コードの可読性を向上させる。
3.  **CIへの組み込み:**
    - `pnpm lint`コマンドをCIプロセスに追加し、Linterのエラーがある場合はマージをブロックする。

## 3. 改善開発計画

上記改善案を以下のフェーズと優先度で進めることを提案する。

| Phase | タスク内容                                                     | 担当パッケージ/領域             | 期間（目安） | 優先度 |
| :---- | :------------------------------------------------------------- | :------------------------------ | :----------- | :----- |
| 1     | **信頼性強化 (基盤整備)**                                      |                                 | 2週間        | **高** |
|       | 1-1. Biome Linterの有効化と推奨ルールの適用                    | `.` (全パッケージ)              | (1週目)      |        |
|       | 1-2. Jestテストカバレッジの現状計測と閾値の導入                  | `.` (全パッケージ)              | (2週目)      |        |
| 2     | **保守性向上 (リファクタリング)**                              |                                 | 4週間        | **中** |
|       | 2-1. `nodes-base`における認証処理の共通化リファクタリング      | `packages/nodes-base`           | (1-2週目)    |        |
|       | 2-2. `nodes-base`におけるリクエスト処理の共通化リファクタリング | `packages/nodes-base`           | (3-4週目)    |        |
| 3     | **可読性向上 (フロントエンド)**                                |                                 | 3週間        | **中** |
|       | 3-1. フロントエンド状態管理方針のドキュメント化                | `packages/frontend/editor-ui`   | (1週目)      |        |
|       | 3-2. Piniaストアへの状態移行リファクタリング (パイロット実装) | `packages/frontend/editor-ui`   | (2-3週目)    |        |
| 4     | **性能向上 (実行エンジン)**                                    |                                 | 6週間        | **低** |
|       | 4-1. ワークフロー実行エンジンの並列実行可能性の調査と設計     | `packages/core`, `packages/workflow` | (1-2週目)    |        |
|       | 4-2. 並列実行のプロトタイプ実装とベンチマーク                 | `packages/core`, `packages/workflow` | (3-6週目)    |        |

---
*この計画は、現状の分析に基づくものであり、各タスクの実施前には、より詳細な影響調査と設計を行うことが望ましい。*
